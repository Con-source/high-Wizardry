# High Wizardry Docker Compose Configuration
# For development, testing, and production deployments

services:
  # Main game server
  game-server:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: high-wizardry-game
    restart: unless-stopped
    ports:
      - "${PORT:-8080}:8080"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=8080
      # Email configuration (optional)
      - EMAIL_ENABLED=${EMAIL_ENABLED:-false}
      - EMAIL_SERVICE=${EMAIL_SERVICE:-}
      - EMAIL_HOST=${EMAIL_HOST:-}
      - EMAIL_PORT=${EMAIL_PORT:-587}
      - EMAIL_SECURE=${EMAIL_SECURE:-false}
      - EMAIL_USER=${EMAIL_USER:-}
      - EMAIL_PASS=${EMAIL_PASS:-}
      - EMAIL_FROM=${EMAIL_FROM:-noreply@highwizardry.game}
      - EMAIL_REQUIRE_VERIFICATION=${EMAIL_REQUIRE_VERIFICATION:-true}
    volumes:
      # Persist game data
      - game-data:/app/server/data
      # Persist backups
      - game-backups:/app/backups
    healthcheck:
      test: ["CMD", "node", "-e", "const http = require('http'); const options = { host: 'localhost', port: 8080, path: '/api/health', timeout: 5000 }; const req = http.get(options, res => { process.exit(res.statusCode === 200 ? 0 : 1); }); req.on('error', () => process.exit(1));"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - game-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # Nginx reverse proxy (for production with SSL)
  nginx:
    image: nginx:alpine
    container_name: high-wizardry-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/logs:/var/log/nginx
    depends_on:
      game-server:
        condition: service_healthy
    networks:
      - game-network
    profiles:
      - production
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # Certbot for SSL certificate management
  certbot:
    image: certbot/certbot
    container_name: high-wizardry-certbot
    volumes:
      - ./nginx/ssl:/etc/letsencrypt
      - ./nginx/certbot-webroot:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - game-network
    profiles:
      - production

# Named volumes for data persistence
volumes:
  game-data:
    driver: local
  game-backups:
    driver: local

# Networks
networks:
  game-network:
    driver: bridge
